<?xml version="1.0"?>
<section>
  <title>http</title>
  <para>The http module performs GET requests over either HTTP or HTTPS and checks the return code and optionally the body.</para>
  <variablelist>
    <varlistentry>
      <term>loader</term>
      <listitem>
        <para>lua</para>
      </listitem>
    </varlistentry>
    <varlistentry>
      <term>object</term>
      <listitem>
        <para>noit.module.http</para>
      </listitem>
    </varlistentry>
  </variablelist>
  <section>
    <title>Module Configuration</title>
  </section>
  <section>
    <title>Check Configuration</title>
    <variablelist>
      <varlistentry>
        <term>url</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>required</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The URL including schema and hostname (as you would type into a browser's location bar).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>header_(\S+)</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>Allows the setting of arbitrary HTTP headers in the request.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>method</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>GET</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>\S+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The HTTP method to use.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>payload</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.*</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The information transferred as the payload of an HTTP request.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>auth_method</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>^(?:Basic|Digest|Auto)$</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>HTTP Authentication method to use.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>auth_user</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>[^:]*</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The user to authenticate as.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>auth_password</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.*</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The password to use during authentication.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>ca_chain</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A path to a file containing all the certificate authorities that should be loaded to validate the remote certificate (for SSL checks).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>certificate_file</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A path to a file containing the client certificate that will be presented to the remote server (for SSL checks).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>key_file</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A path to a file containing key to be used in conjunction with the cilent certificate (for SSL checks).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>ciphers</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>A list of ciphers to be used in the SSL protocol (for SSL checks).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>code</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>^200$</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The HTTP code that is expected.  If the code received does not match this regular expression, the check is marked as "bad."</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>redirects</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>0</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>\d+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>The maximum number of Location header redirects to follow.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>body</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>This regular expression is matched against the body of the response. If a match is not found, the check will be marked as "bad."</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>body_match_*</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>This regular expression is matched against the body of the response. If a match is found it is captured and added as a metric. For example, if setting is named 'body_match_foo_bar' and a match is found new metric called 'foo_bar' will be added.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>extract</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>.+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>This regular expression is matched against the body of the response globally.  The first capturing match is the key and the second capturing match is the value.  Each key/value extracted is registered as a metric for the check.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>pcre_match_limit</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>10000</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>\d+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>This sets the PCRE internal match limit (see pcreapi documentation).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>include_body</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>false</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>^(?:true|false|on|off)$</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>Include whole response body as a metric with the key 'body'.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>read_limit</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>0</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>\d+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>Sets an approximate limit on the data read (0 means no limit).</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>http_version</term>
        <listitem>
          <variablelist>
            <varlistentry>
              <term>required</term>
              <listitem>
                <para>optional</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>default</term>
              <listitem>
                <para>1.1</para>
              </listitem>
            </varlistentry>
            <varlistentry>
              <term>allowed</term>
              <listitem>
                <para>\d+\.\d+</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <para>Sets the HTTP version for the check to use.</para>
        </listitem>
      </varlistentry>
    </variablelist>
  </section>
  <example>
    <title>Checking an HTTP and HTTPS URL.</title>
    <para>This example checks the OmniTI Labs website over both HTTP and HTTPS.</para>
    <programlisting>
      &lt;noit&gt;
        &lt;modules&gt;
          &lt;loader image="lua" name="lua"&gt;
            &lt;config&gt;&lt;directory&gt;/opt/reconnoiter/libexec/modules-lua/?.lua&lt;/directory&gt;&lt;/config&gt;
          &lt;/loader&gt;
          &lt;module loader="lua" name="http" object="noit.module.http" /&gt;
        &lt;/modules&gt;
        &lt;checks&gt;
          &lt;labs target="8.8.38.5" module="http"&gt;
            &lt;check uuid="fe3e984c-7895-11dd-90c1-c74c31b431f0" name="http"&gt;
              &lt;config&gt;&lt;url&gt;http://labs.omniti.com/&lt;/url&gt;&lt;/config&gt;
            &lt;/check&gt;
            &lt;check uuid="1ecd887a-7896-11dd-b28d-0b4216877f83" name="https"&gt;
              &lt;config&gt;&lt;url&gt;https://labs.omniti.com/&lt;/url&gt;&lt;/config&gt;
            &lt;/check&gt;
          &lt;/labs&gt;
        &lt;/checks&gt;
      &lt;/noit&gt;
    </programlisting>
  </example>
</section>
